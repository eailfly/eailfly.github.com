
<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/solid.css">


    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Hello, World! Atom">





<meta name="author" content="EaiLFly" />
<meta name="description" content="在tomcat的server.xml文件中，Host主机配置区域找到类似如下(Value标签元素)即为访问日志的配置： &lt;Host name=&#34;localhost&#34; appBase=&#34;webapps&#34; unpackWARs=&#34;true&#34; autoDeploy=&#34;true&#34;&gt; &lt;!--...部分内容略..--&gt; &lt;Valve className=&#34;org.apache.catalina.valves.AccessLogValve&#34; directory=&#34;logs&#34; prefix=&#34;localhost_access_log.&#34; suffix=&#34;.txt&#34; pattern=&#34;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&#34; /&gt; &lt;/Host&gt; 其中的directory用于指定日志的存放路径，默认位于tomcat的logs目录中，例如我们可以修改成：directory=&#34;/var/log/tomcat&#34; 使日志放到/var/log/tomcat目录中去 …" />
<meta name="keywords" content="">


<meta property="og:site_name" content="Hello, World!"/>
<meta property="og:title" content="配置Tomcat的访问日志格式化输出"/>
<meta property="og:description" content="在tomcat的server.xml文件中，Host主机配置区域找到类似如下(Value标签元素)即为访问日志的配置： &lt;Host name=&#34;localhost&#34; appBase=&#34;webapps&#34; unpackWARs=&#34;true&#34; autoDeploy=&#34;true&#34;&gt; &lt;!--...部分内容略..--&gt; &lt;Valve className=&#34;org.apache.catalina.valves.AccessLogValve&#34; directory=&#34;logs&#34; prefix=&#34;localhost_access_log.&#34; suffix=&#34;.txt&#34; pattern=&#34;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&#34; /&gt; &lt;/Host&gt; 其中的directory用于指定日志的存放路径，默认位于tomcat的logs目录中，例如我们可以修改成：directory=&#34;/var/log/tomcat&#34; 使日志放到/var/log/tomcat目录中去 …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/pei-zhi-tomcatde-fang-wen-ri-zhi-ge-shi-hua-shu-chu.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2014-08-02 13:23:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/eailfly.html">
<meta property="article:section" content="misc"/>
<meta property="og:image" content="">

  <title>Hello, World! &ndash; 配置Tomcat的访问日志格式化输出</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="">
        <img src="/theme/img/profile.png" alt="" title="">
      </a>

      <h1>
        <a href=""></a>
      </h1>



      <nav>
        <ul class="list">



            <li>
              <a target="_self" href="http://getpelican.com/" >Pelican</a>
            </li>
            <li>
              <a target="_self" href="http://python.org/" >Python.org</a>
            </li>
            <li>
              <a target="_self" href="http://jinja.pocoo.org/" >Jinja2</a>
            </li>
            <li>
              <a target="_self" href="#" >You can modify those links in your config file</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-You can add links in your config file" href="#" target="_blank">
              <i class="fab fa-You can add links in your config file"></i>
            </a>
          </li>
          <li>
            <a  class="sc-Another social link" href="#" target="_blank">
              <i class="fab fa-Another social link"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="pei-zhi-tomcatde-fang-wen-ri-zhi-ge-shi-hua-shu-chu">配置Tomcat的访问日志格式化输出</h1>
    <p>
      Posted on Sat 02 August 2014 in <a href="/category/misc.html">misc</a>

    </p>
  </header>


  <div>
    <p>在tomcat的server.xml文件中，Host主机配置区域找到类似如下(Value标签元素)即为访问日志的配置：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">&quot;localhost&quot;</span>  <span class="na">appBase=</span><span class="s">&quot;webapps&quot;</span>
    <span class="na">unpackWARs=</span><span class="s">&quot;true&quot;</span> <span class="na">autoDeploy=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!--...部分内容略..--&gt;</span>
    <span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span>
        <span class="na">directory=</span><span class="s">&quot;logs&quot;</span>
        <span class="na">prefix=</span><span class="s">&quot;localhost_access_log.&quot;</span> <span class="na">suffix=</span><span class="s">&quot;.txt&quot;</span>
        <span class="na">pattern=</span><span class="s">&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot;</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;/Host&gt;</span>
</pre></div>


<p>其中的directory用于指定日志的存放路径，默认位于tomcat的logs目录中，例如我们可以修改成：<code>directory="/var/log/tomcat"</code> 使日志放到/var/log/tomcat目录中去。
其中的prefix和suffic分别用于指定日志文件的前缀和后缀，不用我多说。
现在我们主要来看一下pattern配置段，它用于指定日志的输出格式。有效的日志格式模式可以参见下面内容，如下字符串，其对应的信息由指定的响应内容取代：</p>
<div class="highlight"><pre><span></span>％a - 远程IP地址％A - 本地IP地址
％b - 发送的字节数，不包括HTTP头，或“ - ”如果没有发送字节
％B - 发送的字节数，不包括HTTP头
％h - 远程主机名
％H - 请求协议
％l <span class="o">(</span>小写的L<span class="o">)</span>- 远程逻辑从identd的用户名（总是返回<span class="s1">&#39; - &#39;</span>）
％m - 请求方法
％p - 本地端口
％q - 查询字符串（在前面加上一个“？”如果它存在，否则是一个空字符串
％r - 第一行的要求
％s - 响应的HTTP状态代码
％S - 用户会话ID
％t - 日期和时间，在通用日志格式
％u - 远程用户身份验证
％U - 请求的URL路径
％v - 本地服务器名
％D - 处理请求的时间（以毫秒为单位）
％T - 处理请求的时间（以秒为单位）
％I （大写的i） - 当前请求的线程名称
</pre></div>


<p>此外，您可以指定以下别名来设置为普遍使用的模式之一：</p>
<div class="highlight"><pre><span></span>common - %h %l %u %t <span class="s2">&quot;%r&quot;</span> %s %b
combined - %h %l %u %t <span class="s2">&quot;%r&quot;</span> %s %b <span class="s2">&quot;%{Referer}i&quot;</span> <span class="s2">&quot;%{User-Agent}i&quot;</span>
</pre></div>


<p>另外，还可以将request请求的查询参数、session会话变量值、cookie值或HTTP请求/响应头内容的变量值等内容写入到日志文件。
它仿照了apache的语法：</p>
<div class="highlight"><pre><span></span>％<span class="o">{</span>XXX<span class="o">}</span>i xxx代表传入的头<span class="o">(</span>HTTP Request<span class="o">)</span>
％<span class="o">{</span>XXX<span class="o">}</span>o xxx代表传出的响应头<span class="o">(</span>Http Resonse<span class="o">)</span>
％<span class="o">{</span>XXX<span class="o">}</span>c xxx代表特定的Cookie名
％<span class="o">{</span>XXX<span class="o">}</span>r xxx代表ServletRequest属性名
％<span class="o">{</span>XXX<span class="o">}</span>s xxx代表HttpSession中的属性名
</pre></div>


<p>举例说明：
例如我们在架设jsp服务器时，采用Nginx+Tomcat这种配置时，将请求由Nginx转发给Tomcat，当需要在tomcat的日志中记录来访者的真实IP地址信息时，我们就需要做一点点有别于其它的特殊匹配了，要不然tomcat记录的访客IP全都是127.0.0.1, 这是因为所有的请求都是由Nginx前端服务器转发而来的，而前端服务器对于tomcat来说就是127.0.0.1。</p>
<p>下面，我们来看一下如何让tomcat记录用户的真实IP地址：
一、配置Nginx转发IP头：
在Nginx的server主机配置段中添加：</p>
<div class="highlight"><pre><span></span>proxy_set_header      Host <span class="nv">$host</span><span class="p">;</span>
proxy_set_header      X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</pre></div>


<p>说明：上面两行用于向tomcat发送真实的远端主机名和IP地址。其中的Host代表主机名， X-Real-IP代表主机IP，对于HTTP头部内容，这些变量是不区分大小写的。</p>
<p>二、配置Tomcat日志记录客户真实IP：
在Tomcat中要记录来访者真实IP，大家参考上面所述的tomcat日志配置语法，只需在日志模式中添加如下模式就行了：%{X-Real-IP}i
如下面完整的Tomcat日志配置段：</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span>
<span class="na">directory=</span><span class="s">&quot;c:/wwwlogs/&quot;</span> <span class="na">prefix=</span><span class="s">&quot;cluster.&quot;</span> <span class="na">suffix=</span><span class="s">&quot;.log&quot;</span>
<span class="na">pattern=</span><span class="s">&quot;%{X-Real-IP}i %u %t %r %s %b&quot;</span> <span class="na">resolveHosts=</span><span class="s">&quot;false&quot;</span> <span class="nt">/&gt;</span>
</pre></div>


<p>注意：上两两处修改后，您应该重新启动Nginx和Tomcat服务，以使您的修改生效。这样，当有新的请求过来时，便可以在Tomcat日志文件中记录访客的真实IP地址了。</p>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Hello, World! ",
  "url" : "",
  "image": "",
  "description": ""
}
</script>


</body>
</html>